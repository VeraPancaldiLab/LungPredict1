---
title: "Heatmaps_figures"
author: "Marcelo Hurtado"
date: '2023-01-14'
output: html_document
---

Load packages and functions
```{r}
source(paste0(getwd(),"/environment_set.R"))
libraries_set()
```

Datasets
```{r}
dataset = "LungPredict"
dataset = "Vanderbilt"
dataset = "Response"
dataset = "LPVan_Early"
```

Input data
```{r}
clinical.data <- read.csv(paste0(getwd(),"/Input/ClinicalData/ClinicalData_", dataset, ".csv"), row.names = 1)
deconv <- read.csv(paste0(getwd(),"/Output/EarlyStage/Deconvolution_afterFS_EarlyStage.csv"), row.names = 1)
pathways <- read.csv(paste0(getwd(),"/Output/Pathways/Pathways_Progeny_", dataset, ".csv"), row.names = 1)
immunescores <- read.csv(paste0(getwd(),"/Output/Immunoscores/ImmuneScores_", dataset, ".csv"), row.names = 1)
TFs <- read.csv(paste0(getwd(),"/Output/TFs/TFs_scores_all_", dataset, ".csv"), row.names = 1)
integration <- read.csv(paste0(getwd(), "/Output/DataIntegration/Deconvolution_Integration_EARLYSTAGE.csv"), row.names=1)
```

Setting for plotting
```{r}
immunescores = minMax(immunescores)
clinical.data = cbind(clinical.data, immunescores)
ha = heatmap_annotation(clinical.data)
```

Deconvolution
```{r}
dend_row = hc
ht1 = Heatmap(t(scale(deconv)), 
        border = T,
        top_annotation = ha, clustering_distance_columns = "euclidean",
        #cluster_columns = dend_column, column_gap = unit(8, "mm"),
        #cluster_rows = hc,
        name = "Deconvolution", clustering_method_rows = "ward.D2", clustering_method_columns = "ward.D2",
        column_dend_height = unit(10, "cm"), row_dend_width = unit(10, "cm"), 
        column_dend_reorder = T, row_dend_reorder = T,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 12), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(45, "cm"), height = unit(15, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

png(paste0(getwd(),"/Figures/EarlyStage/Deconvolution_", dataset, ".png"), width = 7500, height = 5000, res=250)
draw(ht1, show_heatmap_legend = T, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
```

TFs scores  
```{r}
TFs_top = TFs_top[order(rowVars(TFs_top), decreasing=TRUE)[1:50],]
col_fun = colorRamp2(c(-4, 0, 4), c("green", "white", "red"))

dend_column = as.dendrogram(hclust(dist(t(TFs_top)), method = "ward.D2"))

ht1 = Heatmap(t(scale(t(TFs_top))), 
        top_annotation = ha, column_gap = unit(8, "mm"), border = T,
        name = "TFs score", col = col_fun, 
        cluster_columns = dend_column,  
        show_row_names = T, clustering_method_rows = "ward.D2", clustering_method_columns = "ward.D2",
        column_dend_height = unit(10, "cm"), row_dend_width = unit(10, "cm"), 
        row_dend_reorder = F, column_dend_reorder = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 12),
        column_names_gp = gpar(fontsize =12),
        width = unit(30, "cm"), height = unit(30, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

png(paste0(getwd(),"/Figures/EarlyStage/TFs_all_", dataset, ".png"), width = 6000, height = 5000, res=250)
draw(ht1, show_heatmap_legend = T, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
```

Integration
```{r}
dend_column = as.dendrogram(hclust(dist(integration), method = "ward.D2"))

ht1 = Heatmap(t(scale(integration)), 
        border = T,
        top_annotation = ha, 
        cluster_columns = dend_column, column_gap = unit(8, "mm"),
        name = "Deconvolution", clustering_method_rows = "ward.D2", clustering_method_columns = "ward.D2",
        column_dend_height = unit(10, "cm"), row_dend_width = unit(10, "cm"), 
        column_dend_reorder = T, row_dend_reorder = F,
        show_row_names = T, 
        show_heatmap_legend = T, 
        row_names_gp = gpar(fontsize = 16), 
        column_names_gp = gpar(fontsize =12), 
        width = unit(30, "cm"), height = unit(15, "cm"),
        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(12, "cm"), 
                                    legend_heigh = unit(12, "cm"), title_gp = gpar(fontsize = 12)))

png(paste0(getwd(),"/Figures/EarlyStage/Deconvolution_Features", dataset, ".png"), width = 6000, height = 4000, res=250)
draw(ht1, show_heatmap_legend = T, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
```


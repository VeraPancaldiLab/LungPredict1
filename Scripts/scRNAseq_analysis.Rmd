---
title: "Single cell analysis"
author: "Marcelo Hurtado"
date: "2023-07-10"
output: html_document
---

Load packages and functions
```{r}
library(Seurat)
library(SeuratDisk)
library(patchwork)
library(SingleR)
library(celldex)
```

```{r}
remotes::install_version("SeuratObject", "4.1.4", repos = c("https://satijalab.r-universe.dev", getOption("repos")))
remotes::install_version("Seurat", "4.4.0", repos = c("https://satijalab.r-universe.dev", getOption("repos")))
```

To install SeuratDisk, first
- sudo apt-get install libhdf5-dev

Load seurat object 
```{r}
#Convert("all_samples.h5ad", dest = "h5seurat", overwrite = T)
seurat_anndata = LoadH5Seurat("~/all_samples.h5seurat",  assays = "RNA")
```

Cell annotations 

==========================================================================================================================================

Annotated ct higher
```{r}
Idents(seurat_anndata) = seurat_anndata@meta.data$annotated_ct_higher
DimPlot(seurat_anndata, reduction="umap", label = T)
```

Annotated ct
```{r}
Idents(seurat_anndata) = seurat_anndata@meta.data$annotated_ct
DimPlot(seurat_anndata, reduction="umap", label = T)
```

Score ct
```{r}
Idents(seurat_anndata) = seurat_anndata@meta.data$scorect
DimPlot(seurat_anndata, reduction="umap", label = T)
```

Cluster identification
```{r}
DimPlot(seurat_anndata, reduction="umap")
ElbowPlot(seurat_anndata) #determine dimensionality of data
seurat_anndata = FindNeighbors(seurat_anndata, dims = 1:20)
seurat_anndata = FindClusters(seurat_anndata, resolution = 1)
DimPlot(seurat_anndata, reduction="umap", label = T)
```
Cell annotation (ATLAS)
```{r}
ref = celldex::HumanPrimaryCellAtlasData()
single_counts = GetAssayData(seurat_anndata, slot='counts')
pred = SingleR(test = single_counts, 
        ref = ref,
        labels = ref$label.main)
seurat_anndata$singleR.labels = pred$labels[match(rownames(seurat_anndata@meta.data), rownames(pred))]
DimPlot(seurat_anndata, reduction = 'umap', group.by = 'singleR.labels')
head(pred$scores)
plotScoreHeatmap(pred)
plotDeltaDistribution(pred)
tab = table(Assigned = pred$labels, Clusters = seurat_anndata$seurat_clusters)
pheatmap::pheatmap(log10(tab+10), color=colorRampPalette(c('white', 'blue'))(10))
Idents(seurat_anndata) = seurat_anndata@meta.data$singleR.labels #Rename clusters
```

Cell annotation (DatabaseImmuneCellExpressionData)
```{r}
ref = celldex::DatabaseImmuneCellExpressionData()
single_counts = GetAssayData(seurat_anndata, slot='counts')
pred = SingleR(test = single_counts, 
        ref = ref,
        labels = ref$label.main)
seurat_anndata$singleR.labels = pred$labels[match(rownames(seurat_anndata@meta.data), rownames(pred))]
DimPlot(seurat_anndata, reduction = 'umap', group.by = 'singleR.labels')
head(pred$scores)
plotScoreHeatmap(pred)
plotDeltaDistribution(pred)
tab = table(Assigned = pred$labels, Clusters = seurat_anndata$seurat_clusters)
pheatmap::pheatmap(log10(tab+10), color=colorRampPalette(c('white', 'blue'))(10))
Idents(seurat_anndata) = seurat_anndata@meta.data$singleR.labels #Rename clusters
```

Cell annotation (MonacoImmuneData)
```{r}
ref = celldex::MonacoImmuneData()
single_counts = GetAssayData(seurat_anndata, slot='counts')
pred = SingleR(test = single_counts, 
        ref = ref,
        labels = ref$label.main)
seurat_anndata$singleR.labels = pred$labels[match(rownames(seurat_anndata@meta.data), rownames(pred))]
DimPlot(seurat_anndata, reduction = 'umap', group.by = 'singleR.labels')
head(pred$scores)
plotScoreHeatmap(pred)
plotDeltaDistribution(pred)
tab = table(Assigned = pred$labels, Clusters = seurat_anndata$seurat_clusters)
pheatmap::pheatmap(log10(tab+10), color=colorRampPalette(c('white', 'blue'))(10))
Idents(seurat_anndata) = seurat_anndata@meta.data$singleR.labels #Rename clusters
```

Cell annotation (BlueprintEncodeData)
```{r}
ref = celldex::BlueprintEncodeData()
single_counts = GetAssayData(seurat_anndata, slot='counts')
pred = SingleR(test = single_counts, 
        ref = ref,
        labels = ref$label.main)
seurat_anndata$singleR.labels = pred$labels[match(rownames(seurat_anndata@meta.data), rownames(pred))]
DimPlot(seurat_anndata, reduction = 'umap', group.by = 'singleR.labels')
head(pred$scores)
plotScoreHeatmap(pred)
plotDeltaDistribution(pred)
tab = table(Assigned = pred$labels, Clusters = seurat_anndata$seurat_clusters)
pheatmap::pheatmap(log10(tab+10), color=colorRampPalette(c('white', 'blue'))(10))
Idents(seurat_anndata) = seurat_anndata@meta.data$singleR.labels #Rename clusters
```

NK cluster annotation (2,6,8)
```{r}
NK268 = subset(seurat_anndata, idents = c("2", "6","8"), invert = FALSE)
DimPlot(NK268, reduction="umap")

#Re-clustering
NK268 = FindNeighbors(NK268, dims = 1:20)
NK268 = FindClusters(NK268, algorithm= 1, resolution = 0.1)
NK268 <- RunUMAP(NK268, dims = 1:20)
DimPlot(NK268, reduction="umap", label = T, pt.size = 0.5) 
```
Features NK
```{r}
featuresNK = c("GNLY", "KLRK1", "KLRC2", "KLRC3", "CD3E", "NCAM1", "FCGR3A", "CD226", "GZMA", "GZMB", "GZMH", "GZMK", "PRF1", "TNF", "IFNG", "IL7R",
               "KLF2", "S1PR5", "ITGAE", "ZNF683")
FeaturePlot(NK268, features = featuresNK)
VlnPlot(NK268, features = featuresNK, log = T)
```
NK cluster annotation 8
```{r}
NK8 = subset(seurat_anndata, idents = "8", invert = FALSE)
DimPlot(NK8, reduction="umap")

#Re-clustering
NK8 = FindNeighbors(NK8, dims = 1:20)
NK8 = FindClusters(NK8, algorithm= 1, resolution = 0.1)
NK8 <- RunUMAP(NK8, dims = 1:20)
DimPlot(NK8, reduction="umap", label = T, pt.size = 0.5) 
```
Features
```{r}
VlnPlot(NK8, features = featuresNK, log = T)
markers = FindMarkers(NK8, ident.1 = "0", ident.2 = "1")
head(markers, n=20)
```

NK cluster annotation (6,8)
```{r}
NK68 = subset(seurat_anndata, idents = c("6","8"), invert = FALSE)
DimPlot(NK68, reduction="umap")

#Re-clustering
NK68 = FindNeighbors(NK68, dims = 1:20)
NK68 = FindClusters(NK68, algorithm= 1, resolution = 0.1)
NK68 <- RunUMAP(NK68, dims = 1:20)
DimPlot(NK68, reduction="umap", label = T, pt.size = 0.5) 
```
Features
```{r}
VlnPlot(NK68, features = featuresNK, log = T)
markers = FindMarkers(NK68, ident.1 = "0", ident.2 = "1")
head(markers, n=20)
```
NK cluster based on public annotation 
```{r}
Idents(seurat_anndata) = seurat_anndata@meta.data$annotated_ct
NK = subset(seurat_anndata, idents = c("NK cells"), invert = FALSE)
DimPlot(NK, reduction="umap")

#Re-clustering
NK = FindNeighbors(NK, dims = 1:20)
NK = FindClusters(NK, algorithm= 1, resolution = 0.1)
NK <- RunUMAP(NK, dims = 1:20)
DimPlot(NK, reduction="umap", label = T, pt.size = 0.5) 
```
Features
```{r}
VlnPlot(NK, features = featuresNK, log = T)
markers = FindMarkers(NK, ident.1 = "0", ident.2 = "1")
head(markers, n=20)
```

Cell proportions 
```{r}
library(dplyr)
library(tibble)
subcluster = NK
total = list()
patients = levels(subcluster@meta.data$sample)

for (i in 1:length(patients)) {
  total[[i]] = subcluster@meta.data %>%
    filter(sample %in% patients[i])
}
names(total) = patients

cell_types = levels(subcluster)
cells = list()
counts = c()
for (i in 1:length(total)) {
  for (j in 1:length(cell_types)) {
    data = total[[i]] %>%
      filter(seurat_clusters %in% cell_types[j])
    counts = c(counts, nrow(data))
  }
  counts = as.vector(counts)
  names(counts) = cell_types
  cells[[i]] = counts
  counts = c()
}
names(cells) = patients

proportions = list()
ratio = c()
for (i in 1:length(cells)) {
  for (j in cell_types) {
    ratio = c(ratio, round(cells[[i]][[j]]/nrow(total[[i]]), 6))
  }
  ratio = as.vector(ratio)
  names(ratio) = cell_types
  proportions[[i]] = ratio
  ratio = c()
}
names(proportions) = patients
```

Check samples that have both single cell and bulk data
```{r}
levels(seurat_anndata@meta.data$sample)
clinical.data <- data.frame(read.csv("~/Documents/LungPredict1_complete/RawFiles/ColumnData_Vanderbilt.csv", row.names = 1))
clinical.data <- clinical.data[,c(1,5,6,9,11,13)]

coldata = clinical.data[clinical.data$pt_ID%in%levels(seurat_anndata@meta.data$sample),]

#14958 14965 11817 13634 15467 12929  8356 12889 15002
#"R3388_YZ_1"  "R3388_YZ_2"  "R3388_YZ_10" "R3388_YZ_11" "R3388_YZ_18" "R3388_YZ_28" "R3388_YZ_56" "R4163_YZ_16" "R4163_YZ_25"
```

Plot cell proportions
```{r}
library(ggplot2)
##Prepare data
data = list()
for (i in 1:length(proportions)){
  data[[i]] = data.frame("Sample" = rep(names(proportions)[i], length(cell_types)),
                    "Cells_types" = cell_types,
                    "Value" = unname(proportions[[i]]))}
data = bind_rows(data)

data$Patient = data$Sample
for (i in 1:nrow(data)) {
  idx = which(coldata$pt_ID %in% data$Sample[i])
  if(length(idx)>0){
    data$Patient[i] = rownames(coldata)[idx]
  }
}

p1 = ggplot(data) +
  geom_bar(aes(x = Patient, y = Value, fill = Cells_types), 
           position = "stack", stat = "identity")
p1

```
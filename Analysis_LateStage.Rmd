---
title: "Analysis Late Stage"
author: "Marcelo Hurtado"
date: "2023-06-14"
output: html_document
---

Load packages and functions
```{r}
source(paste0(getwd(),"/environment_set.R"))
libraries_set()
```

Load algorithm for subgrouping
```{r}
source(paste0(getwd(),"/Algorithm_subgrouping.R"))
```

Load input data
```{r}
deconv1 <- as.matrix(read.csv(paste0(getwd(),"/Input/Deconvolution/Deconvolution_LungPredict.csv"), row.names = 1))
clinical.data1 <- read.csv(paste0(getwd(),"/Input/ClinicalData/ClinicalData_LungPredict.csv"), row.names = 1)
deconv2 <- as.matrix(read.csv(paste0(getwd(),"/Input/Deconvolution/Deconvolution_ImmunoPredict.csv"), row.names = 1))
clinical.data2 <- read.csv(paste0(getwd(),"/Input/ClinicalData/ClinicalData_ImmunoPredict.csv"), row.names = 1)

clinical.data1$EGFR_mut = NULL
clinical.data1$STK11_mut = NULL
clinical.data1$Metastatic = NULL

clinical.data = rbind(clinical.data1, clinical.data2)
clinical.data = clinical.data[which(clinical.data$Stages_simplified=="IV"),] #38 SAMPLES

deconv = rbind(deconv1, deconv2)
deconv = deconv[rownames(deconv)%in%rownames(clinical.data),]

```

Cleaning deconvolution results
```{r}
#Removing CD226
deconv <- deconv[,-grep("CD226", colnames(deconv))]
```

Unsupervised filtering 
```{r}
#Remove columns with low variance (no much change across samples)
deconv = data.frame(deconv[,-which(colVars(deconv)<=summary(colVars(deconv))[2])])
#Remove columns with more than 70% of zeros
i <- colSums(deconv == 0, na.rm=TRUE) < round(0.7*nrow(deconv))
deconv <- data.frame(deconv[, i, drop=FALSE])
```

Split by cell types
```{r}
cells = compute_cell.types(data.frame(deconv))
```

Pairwise correlation filtering
```{r}
for (i in 1:length(cells)) {
  data = cells[[i]]
  if(ncol(data)>1){
    data = removeCorrelatedFeatures(data)
    cells[[i]] = data
  }
}
```

Subgrouping deconvolution 
```{r}
res = list()
groups = list()
groups_similarity = list()
for (i in 1:length(cells)) {
  x = compute_subgroups(cells[[i]], names(cells)[i])
  res = c(res, x[1])
  groups = c(groups, x[2])
  groups_similarity = c(groups_similarity, x[4])
}
names_cells = c("B", "MACROPHAGES", "M0", "M1", "M2", "MONOCYTES", "NEUTROPHILS", "NK", "NK.ACTIVATED", "NK.RESTING", "NKT", "CD4", "CD4.ACTIVATED", "CD4.RESTING", "CD8", "TREGS", "DENDRITIC", "DENDRITIC.ACTIVATED", "DENDRITIC.RESTING", "CANCER", "ENDOTHELIAL", "CAF")
names(res) = names_cells
names(groups) = names_cells
names(groups_similarity) = names_cells

#Res and Groups 
ls = remove_subgroups(groups)
for (i in 1:length(groups)) {
  idx = which(names(groups[[i]])%in%ls)
  idy = which(names(res[[i]])%in%ls)
  if(length(idx)>0){
    groups[[i]] = groups[[i]][-idx] 
    res[[i]] = res[[i]][-idy] 
  }
}
```

Output deconvolution
```{r}
dt = c()
for (i in 1:length(res)) {
  dt = c(dt, res[[i]])
}
dt = data.frame(dt)
rownames(dt) = rownames(deconv)

saveRDS(res, paste0(getwd(),"/Output/LateStage/Groups_cells_all_LATESTAGE.rds"))
saveRDS(groups, paste0(getwd(),"/Output/LateStage/Groups_cells_correlation_LATESTAGE.rds"))
saveRDS(groups_similarity, paste0(getwd(),"/Output/LateStage/Groups_cells_similarity_LATESTAGE.rds"))
write.csv(dt, paste0(getwd(),"/Output/LateStage/Deconvolution_after_LATESTAGE.csv"))
```

TRANSCRIPTION FACTOR ANALYSIS FOR DECONVOLUTION

Input data
```{r}
TFs <- read.csv(paste0(getwd(),"/Output/TFs/VIPER/TFs_scores_all_LateStage.csv"), row.names = 1)
```

TFs filtering
```{r}
#Remove columns with low variance (no much change across samples)
TFs = data.frame(TFs[-which(rowVars(TFs)<=summary(rowVars(TFs))[2]),])
minAbsValue <- abs(min(TFs))
TFs = TFs + minAbsValue
```

Finding modules of TFs
```{r}
hc <- as.dendrogram(hclust(dist(t(scale(t(TFs)))), method = "ward.D2"))
png(paste0(getwd(),"/Figures/LateStage/TFs_clusters_LATESTAGE.png"), width = 7500, height = 4500, res=250)
plot(hc)
rect.dendrogram(hc, h = 15,horiz=F)
dev.off()
clusters <- cutree(hc, h = 15)
```

TFs clustering merging
```{r}
TFs_modules = TFs %>%
  as_tibble() %>%
  mutate("Cluster" = paste0("Cluster ", clusters)) %>%
  group_by(Cluster) %>%
  summarise(across(everything(), mean)) %>%
  column_to_rownames("Cluster")

hc <- as.dendrogram(hclust(dist(t(scale(t(TFs_modules)))), method = "ward.D2"))
plot(hc)
rect.dendrogram(hc, h = 6,horiz=F)
clusters2 <- cutree(hc, h = 6)

TFs_modules_merge = TFs_modules %>%
  as_tibble() %>%
  mutate("Cluster" = paste0("Cluster ", clusters2)) %>%
  group_by(Cluster) %>%
  summarise(across(everything(), mean)) %>%
  column_to_rownames("Cluster")

write.csv(TFs_modules_merge,  paste0(getwd(),"/Output/LateStage/TFs_modules_LATESTAGE.csv"))
```

Correlation between deconvolution and TFs activity across patients
```{r}
nSamples = ncol(TFs_modules_merge)
TFs_modules_merge = TFs_modules_merge[,colnames(TFs_modules_merge)%in%rownames(clinical.data)]
moduleTraitCor = cor(t(TFs_modules_merge), dt, use = "p")
moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples)

textMatrix =  paste(signif(moduleTraitCor, 2), "\n(",
                  signif(moduleTraitPvalue, 1), ")", sep = "")
dim(textMatrix) = dim(moduleTraitCor)
  
idx = which(moduleTraitPvalue>0.05)
for (i in idx) {
  textMatrix[i] = NA
}

d <- dist(t(moduleTraitCor), method = "euclidean")
hc1 <- hclust(d, method = "ward.D2" )
vec = hc1[["order"]]
  
###Figure module-trait relationship
png(paste0(getwd(),"/Figures/LateStage/Module_trait_relationships_LATESTAGE.png"), width = 4000, height = 1500, res=150)
par(mar = c(20, 10, 4, 4)) #bottom, left, top, right
labeledHeatmap(Matrix = moduleTraitCor[,vec],
               xLabels = names(dt[,vec]),
               yLabels = rownames(TFs_modules_merge),
               ySymbols = rownames(TFs_modules_merge),
               colorLabels = FALSE,
               colors = blueWhiteRed(50),
               textMatrix = textMatrix[,vec],
               setStdMargins = FALSE,
               cex.text = 0.8,
               zlim = c(-1,1),
               main = paste("Module-trait relationships"))
dev.off()
```

Groups of cell types based on TF activity 
```{r}
hc = as.dendrogram(hc1)
png(paste0(getwd(),"/Figures/LateStage/Dendogram_Subgroups_cells_LATESTAGE.png"), width = 2500, height = 2500, res=150)
par(mar = c(5, 5, 4, 30)) #bottom, left, top, right
plot(hc, horiz= T)
rect.dendrogram(hc, h=0.8,horiz=TRUE)
dev.off()

clusters3 <- cutree(hc, h = 0.8)

png(paste0(getwd(),"/Figures/LateStage/Deconvolution_LATESTAGE.png"), width = 6000, height = 4500, res=250)
Heatmap(t(scale(dt)), cluster_rows = hc, clustering_method_columns = "ward.D2",width = unit(30, "cm"), height = unit(35, "cm"), column_dend_height = unit(5, "cm"), show_heatmap_legend = F)
dev.off()
```

Integration of deconvolution clusters
```{r}
deconv_df = dt %>%
  t() %>%
  as_tibble() %>%
  mutate("Cluster" = paste0("Cluster_", clusters3)) %>%
  group_by(Cluster) %>%
  summarise(across(everything(), mean)) %>%
  column_to_rownames("Cluster")

write.csv(t(deconv_df),  paste0(getwd(),"/Output/LateStage/Deconvolution_Integration_LATESTAGE.csv"))

png(paste0(getwd(),"/Figures/LateStage/Deconvolution_LATESTAGE_NICHES.png"), width = 6000, height = 4500, res=250)
Heatmap(t(scale(t(deconv_df))), clustering_method_columns = "ward.D2",width = unit(30, "cm"), height = unit(35, "cm"), column_dend_height = unit(5, "cm"), show_heatmap_legend = F)
dev.off()

#Save cell clusters
data = dt %>%
  t() %>%
  as_tibble() %>%
  mutate("Cluster" = clusters3) %>%
  as.data.frame()
rownames(data) = colnames(dt)
niches = list()
for (i in 1:nrow(deconv_df)) {
  niches[[i]] = rownames(data)[which(data$Cluster==i)]
}

saveRDS(niches,  paste0(getwd(),"/Output/LateStage/New3/Cell_groups_LATESTAGE.rds"))
```

Patients clustering from LP and ImmunoPredict
```{r}
hc1 = as.dendrogram(hclust(dist(scale(t(deconv_df))), method = "ward.D2"))
png(paste0(getwd(),"/Figures/LateStage/Patients_clusters_LATESTAGE.png"), width = 2500, height = 1500, res=150)
plot(hc1)
rect.dendrogram(hc1, k=2,horiz=F)
dev.off()

clusters <- cutree(hc1, k=2)
clinical.data$cluster = NULL
clinical.data$cluster = clusters

data = t(deconv_df)
res = random_forest(data.frame(data), clinical.data$cluster, 9)

png(paste0(getwd(),"/Figures/LateStage/Clusters_Feature_Importance_LATESTAGE.png"), width = 2000, height = 1500, res=250)
ggplot(res[[2]], aes(x = reorder(rownames(res[[2]]), -Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Features", y = "Importance") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()

png(paste0(getwd(),"/Figures/LateStage/Deconvolution_LATESTAGE_FS_CLUSTERS.png"), width = 6000, height = 4500, res=250)
ha <- HeatmapAnnotation(Cluster = clinical.data$cluster, col = list(Cluster = c("1" = "green", "2" = "purple")))
Heatmap(t(scale(res[[1]])),  clustering_method_columns = "ward.D2", top_annotation = ha, width = unit(30, "cm"), height = unit(20, "cm"), column_dend_height = unit(10, "cm"), row_dend_width = unit(10, "cm"))
dev.off()
```

Immunotherapy Response analysis
```{r}
response <- read.csv(paste0(getwd(),"/Input/ClinicalData/ClinicalData_Response.csv"), row.names = 1)
response = response[rownames(response)%in%rownames(clinical.data),]

clinical.data = clinical.data[rownames(clinical.data)%in%rownames(response),]
clinical.data$response = response$response

clinical.data = clinical.data[-which(clinical.data$response=="No data"),]

dat = res[[1]]
dat = dat[rownames(dat)%in%rownames(clinical.data),]

hclu = hclust(dist(t(scale(dat))), method = "ward.D2")
plot(as.dendrogram(hclu))
vec = hclu[["order"]]
vec2 = colnames(dat[,vec])
  
ha <- HeatmapAnnotation(Cluster = clinical.data$cluster, Response = clinical.data$response, col = list(Cluster = c("1" = "black", "2" = "purple"), Response = c("Responders" = "green", "Non responders"= "red")))

png(paste0(getwd(),"/Figures/LateStage/Deconvolution_LATESTAGE_FS_CLUSTERS_RESPONSE.png"), width = 6000, height = 3500, res=250)
Heatmap(t(scale(dat[,vec])),  column_split = clinical.data$cluster,  cluster_rows = F, clustering_method_columns = "ward.D2", top_annotation = ha, width = unit(30, "cm"), height = unit(20, "cm"), column_dend_height = unit(5, "cm"), show_heatmap_legend = F)
dev.off()

deconv_df = deconv_df[,colnames(deconv_df)%in%rownames(dat)]
png(paste0(getwd(),"/Figures/LateStage/Deconvolution_LATESTAGE_NICHES_RESPONSE.png"), width = 6000, height = 4500, res=250)
Heatmap(t(scale(t(deconv_df))), clustering_method_columns = "ward.D2", top_annotation = ha, width = unit(30, "cm"), height = unit(35, "cm"), column_dend_height = unit(5, "cm"), show_heatmap_legend = F)
dev.off()
```

Anova test response 
```{r}
RESPONSE <- read.csv(paste0(getwd(),"/Output/LateStage/Anova_response_LPIP.csv", row.names=1))
compute_violin(RESPONSE, clinical.data$response, "LateStage")
```

